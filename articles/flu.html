<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calibration of Quinine Fluorescence Emission • hyperSpec</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Calibration of Quinine Fluorescence Emission">
<meta property="og:description" content="flu: Example workflow for fluorescence emission dataset `flu`.">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hyperSpec</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.100.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Documentation for version of package:</li>
    <li>
      <a href="https://cbeleites.github.io/hyperSpec/">Released</a>
    </li>
    <li>
      <a href="https://cbeleites.github.io/hyperSpec/dev/">In-development</a>
    </li>
  </ul>
</li>
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/hyperSpec.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/fileio.html">Import and Export Files with Spectra</a>
    </li>
    <li>
      <a href="../articles/plotting.html">Plotting Functions in "hyperSpec"</a>
    </li>
    <li>
      <a href="../articles/baseline.html">Fitting Baselines to Spectra</a>
    </li>
    <li class="divider">
    <li>
      <a href="../articles/index.html">More...</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cbeleites/hyperSpec/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="flu_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calibration of Quinine Fluorescence Emission</h1>
            <h3 class="subtitle">Example Workflow for Fluorescence Emission Dataset <code>flu</code>
</h3>
                        <h4 class="author">Claudia Beleites<sup>1,2,3,4,5</sup>, Vilmantas Gegzna</h4>
            <address class="author_afil">
      <ol style="list-style-type: decimal">
<li>DIA Raman Spectroscopy Group, University of Trieste/Italy (2005–2008)</li>
      <li>Spectroscopy <span class="math inline">\(\cdot\)</span> Imaging, IPHT, Jena/Germany (2008–2017)</li>
      <li>ÖPV, JKI, Berlin/Germany (2017–2019)</li>
      <li>Arbeitskreis Lebensmittelmikrobiologie und Biotechnologie, Hamburg University, Hamburg/Germany (2019 – 2020)</li>
      <li>Chemometric Consulting and Chemometrix GmbH, Wölfersheim/Germany (since 2016)</li>
      </ol>
<br><a class="author_email" href="mailto:#"></a><a href="mailto:chemometrie@beleites.de" class="email">chemometrie@beleites.de</a>
      </address>
                  
            <h4 class="date">2020-08-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cbeleites/hyperSpec/blob/master/../vignettes/flu.Rmd"><code>../vignettes/flu.Rmd</code></a></small>
      <div class="hidden name"><code>flu.Rmd</code></div>

    </div>

    
    
<!-- ======================================================================= -->
<!-- ======================================================================= -->
<!-- Note that loading the package, and some definitions, e.g., of the color palettes are executed in `vignettes.def`. -->
<p>This tutorial gives an example how to:</p>
<ul>
<li>write an import function for a spectrometer manufacturer’s proprietary ASCII files,</li>
<li>add further data columns to the spectra, and</li>
<li>set up a linear calibration (inverse least squares).</li>
</ul>
<p>The data set <code class="sourceCode r">flu</code> in package <strong>hyperSpec</strong> consists of 6 fluorescence emission spectra of quinine solutions.
They were acquired during an student practicum and were kindly provided by M. Kammer.</p>
<p>The concentrations of the solutions range from 0.05 to 0.30 mg/l.
Spectra were acquired with a Perkin Elmer LS50-B fluorescence spectrometer at 350 nm excitation.</p>
<div id="writing-an-import-function" class="section level1">
<h1 class="hasAnchor">
<a href="#writing-an-import-function" class="anchor"></a><span class="header-section-number">1</span> Writing an Import Function</h1>
<p>The raw spectra are in Perkin Elmer’s ASCII file format, one spectrum per file.
The files are completely ASCII text, with the actual spectra starting at line 55.</p>
<!-- ======================================================================= -->
<!-- ======================================================================= -->
<p>The function to import these files, <code class="sourceCode r"><span class="kw">read.txt.PerkinElmer</span>()</code>, is discussed in the “fileIO” vignette, please refer to that document for details.</p>
<!-- ======================================================================= -->
<!-- ======================================================================= -->
<p>It needs to be <code class="sourceCode r"><span class="kw">source</span>()</code>d before use:</p>
<!-- ======================================================================= -->
<!-- ======================================================================= -->
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"read.txt.PerkinElmer.R"</span>)

<span class="kw">folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/flu"</span>, package = <span class="st">"hyperSpec"</span>)
<span class="kw">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw">folder</span>, <span class="st">"/flu?.txt"</span>))
<span class="kw">flu</span> <span class="op">&lt;-</span> <span class="fu">read.txt.PerkinElmer</span>(<span class="kw">files</span>, skip = <span class="fl">54</span>)
</pre></div>
<p>Now the spectra are in a <code class="sourceCode r">hyperSpec</code> object and can be examined, e.g., by:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">flu</span>
<span class="co">#&gt; hyperSpec object</span>
<span class="co">#&gt;    6 spectra</span>
<span class="co">#&gt;    2 data columns</span>
<span class="co">#&gt;    181 data points / spectrum</span>
<span class="co">#&gt; wavelength: lambda/nm [numeric] 405.0 405.5 ... 495 </span>
<span class="co">#&gt; data:  (6 rows x 2 columns)</span>
<span class="co">#&gt;    1. spc: I[fl]/"a.u." [matrix, array181] 27.150 66.801 ... 294.65 </span>
<span class="co">#&gt;    2. filename: filename [character] /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu1.txt /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu2.txt ... /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu6.txt</span>
</pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">flu</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:rawfig"></span>
<img src="flu_files/figure-html/rawfig-1.png" alt="Six spectra of `flu` dataset.  "><p class="caption">
Figure 1.1: Six spectra of <code>flu</code> dataset.
</p>
</div>
</div>
<div id="adding-further-data-columns" class="section level1">
<h1 class="hasAnchor">
<a href="#adding-further-data-columns" class="anchor"></a><span class="header-section-number">2</span> Adding further Data Columns</h1>
<p>The calibration model needs the quinine concentrations for the spectra.
This information can be stored together with the spectra, and also gets an appropriate label:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">flu</span><span class="op">$</span><span class="kw">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/seq.hyperSpec.html">seq</a></span>(from = <span class="fl">0.05</span>, to = <span class="fl">0.30</span>, by = <span class="fl">0.05</span>)
<span class="fu"><a href="https://rdrr.io/r/base/labels.html">labels</a></span>(<span class="kw">flu</span>, <span class="st">"c"</span>) <span class="op">&lt;-</span> <span class="st">"c, mg/l"</span>

<span class="kw">flu</span>
<span class="co">#&gt; hyperSpec object</span>
<span class="co">#&gt;    6 spectra</span>
<span class="co">#&gt;    3 data columns</span>
<span class="co">#&gt;    181 data points / spectrum</span>
<span class="co">#&gt; wavelength: lambda/nm [numeric] 405.0 405.5 ... 495 </span>
<span class="co">#&gt; data:  (6 rows x 3 columns)</span>
<span class="co">#&gt;    1. spc: I[fl]/"a.u." [matrix, array181] 27.150 66.801 ... 294.65 </span>
<span class="co">#&gt;    2. filename: filename [character] /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu1.txt /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu2.txt ... /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu6.txt </span>
<span class="co">#&gt;    3. c: c, mg/l [numeric] 0.05 0.10 ... 0.3</span>
</pre></div>
<!-- ======================================================================= -->
<!-- ======================================================================= -->
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span>(<span class="kw">flu</span>, file = <span class="st">"flu.rda"</span>)
</pre></div>
<p>Now the <code class="sourceCode r">hyperSpec</code> object <code class="sourceCode r">flu</code> contains two data columns, holding the actual spectra and the respective concentrations. The dollar operator returns such a data column:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">flu</span><span class="op">$</span><span class="kw">c</span>
<span class="co">#&gt; [1] 0.05 0.10 0.15 0.20 0.25 0.30</span>
</pre></div>
</div>
<div id="sec:dropp-data-columns" class="section level1">
<h1 class="hasAnchor">
<a href="#sec:dropp-data-columns" class="anchor"></a><span class="header-section-number">3</span> Dropping data columns</h1>
<p>Function <code class="sourceCode r"><span class="kw">read.txt.PerkinElmer</span>()</code> added a column with the file names that we don’t need.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">flu</span><span class="op">$</span><span class="kw">..</span>
<span class="co">#&gt;                                                          filename    c</span>
<span class="co">#&gt; 1 /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu1.txt 0.05</span>
<span class="co">#&gt; 2 /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu2.txt 0.10</span>
<span class="co">#&gt; 3 /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu3.txt 0.15</span>
<span class="co">#&gt; 4 /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu4.txt 0.20</span>
<span class="co">#&gt; 5 /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu5.txt 0.25</span>
<span class="co">#&gt; 6 /Users/runner/work/_temp/Library/hyperSpec/extdata/flu/flu6.txt 0.30</span>
</pre></div>
<p>It is therefore deleted:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">flu</span><span class="op">$</span><span class="kw">filename</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
</pre></div>
</div>
<div id="linear-calibration" class="section level1">
<h1 class="hasAnchor">
<a href="#linear-calibration" class="anchor"></a><span class="header-section-number">4</span> Linear Calibration</h1>
<p>As R is developed for the purpose of statistical analysis, tools for a least squares calibration
model are readily available.</p>
<p>The original spectra range from 405 to 495 nm.
However, the intensities at 450 nm are perfect for a univariate calibration.
Plotting them over the concentration is done by:</p>
<!-- \setkeys{Gin}{width = .33\textwidth} -->
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="../reference/plotc.html">plotc</a></span>(<span class="kw">flu</span>[, , <span class="fl">450</span>])
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:calplot1"></span>
<img src="flu_files/figure-html/calplot1-1.png" alt="Spectra intensities at 450 nm. "><p class="caption">
Figure 4.1: Spectra intensities at 450 nm.
</p>
</div>
<p>The square bracket operator extracts parts of a <code class="sourceCode r">hyperSpec</code> object.
The first coordinate defines which spectra are to be used, the second which data columns, and the third gives the spectral range.</p>
<p>We discard all the wavelengths but 450 nm:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">flu</span> <span class="op">&lt;-</span> <span class="kw">flu</span>[, , <span class="fl">450</span>]
<span class="fu"><a href="https://rdrr.io/r/base/labels.html">labels</a></span>(<span class="kw">flu</span>, <span class="st">"spc"</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw">I</span>[<span class="st">"450 nm"</span>] <span class="op">/</span> <span class="kw">a.u.</span>)
</pre></div>
<p>The plot could be enhanced by annotating the ordinate with the emission wavelength.
Also the axes should start at the origin, so that it is easier to see whether the calibration function will go through the origin:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="../reference/plotc.html">plotc</a></span>(<span class="kw">flu</span>, xlim = <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="fl">0</span>, <span class="kw">flu</span><span class="op">$</span><span class="kw">c</span>), ylim = <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="fl">0</span>, <span class="kw">flu</span><span class="op">$</span><span class="kw">spc</span>))
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:calplot2"></span>
<img src="flu_files/figure-html/calplot2-1.png" alt="Spectra intensities at 450 nm with updated labels. "><p class="caption">
Figure 4.2: Spectra intensities at 450 nm with updated labels.
</p>
</div>
<p>The actual calibration is a linear model, which can be fitted by the R function <code class="sourceCode r"><span class="kw">lm</span>()</code>.
The function <code class="sourceCode r"><span class="kw">lm</span>()</code> needs a <em>formula</em> that specifies which data columns are dependent and independent variables.</p>
<p>The normal calibration plot gives the emission intensity as a function of the concentration, and the calibration function thus models <span class="math inline">\(I = f (c)\)</span>, i. e. <span class="math inline">\(I = m c + b\)</span> for a linear calibration.
This is then solved for <span class="math inline">\(c\)</span> when the calibration is used.</p>
<p>However, R’s linear model is a quite strict in predicting: a model set up as <span class="math inline">\(I = f (c)\)</span> will predict the intensity as a function of the concentration but not the other way round.
Thus we set up an inverse calibration model[^As we can safely assume that the error on the concentrations is far larger than the error on the instrument signal, it is actually the correct type of model from the least squares fit point of view.]: <span class="math inline">\(c = f (I)\)</span>.
The corresponding formula is <code>c ~ I</code>, or in our case <code>c ~ spc</code>, as the intensities are stored in the data column <code class="sourceCode r"><span class="op">$</span>spc</code>:</p>
<p>In addition, <code class="sourceCode r"><span class="kw">lm</span>()</code> (like most R model building functions) expects the data to be a <code class="sourceCode r">data.frame</code>.</p>
<p>There are three abbreviations that help to get the parts of the <code class="sourceCode r">hyperSpec</code> object that are frequently needed:</p>
<ul>
<li>
<strong><code class="sourceCode r">flu[[]]</code></strong> returns the spectra matrix. It takes the same indices as <code class="sourceCode r">[]</code>.</li>
<li>
<strong><code class="sourceCode r">flu\<span class="op">$</span>.</code></strong> returns the data as a <code class="sourceCode r">data.frame</code>.</li>
<li>
<strong><code class="sourceCode r">flu\<span class="op">$</span>..</code></strong> returns a <code class="sourceCode r">data.frame</code> that has all data columns but the spectra.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="kw">flu</span>[[]]
<span class="co">#&gt;         450</span>
<span class="co">#&gt; [1,] 106.95</span>
<span class="co">#&gt; [2,] 213.50</span>
<span class="co">#&gt; [3,] 333.78</span>
<span class="co">#&gt; [4,] 446.63</span>
<span class="co">#&gt; [5,] 556.52</span>
<span class="co">#&gt; [6,] 672.53</span>
</pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">flu</span><span class="op">$</span><span class="kw">.</span>
<span class="co">#&gt;      450    c</span>
<span class="co">#&gt; 1 106.95 0.05</span>
<span class="co">#&gt; 2 213.50 0.10</span>
<span class="co">#&gt; 3 333.78 0.15</span>
<span class="co">#&gt; 4 446.63 0.20</span>
<span class="co">#&gt; 5 556.52 0.25</span>
<span class="co">#&gt; 6 672.53 0.30</span>
</pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="kw">flu</span><span class="op">$</span><span class="kw">..</span>
<span class="co">#&gt;      c</span>
<span class="co">#&gt; 1 0.05</span>
<span class="co">#&gt; 2 0.10</span>
<span class="co">#&gt; 3 0.15</span>
<span class="co">#&gt; 4 0.20</span>
<span class="co">#&gt; 5 0.25</span>
<span class="co">#&gt; 6 0.30</span>
</pre></div>
<p>Putting this together, the calibration model is calculated:</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="kw">calibration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="kw">c</span> <span class="op">~</span> <span class="kw">spc</span>, data = <span class="kw">flu</span><span class="op">$</span><span class="kw">.</span>)
</pre></div>
<p>The <code class="sourceCode r"><span class="kw">summary</span>()</code> gives a good overview of our model:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="../reference/as.character,hyperSpec-method.html">summary</a></span>(<span class="kw">calibration</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = c ~ spc, data = flu$.)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;         1         2         3         4         5         6 </span>
<span class="co">#&gt; -0.000987  0.002052 -0.000960 -0.000701  0.000864 -0.000267 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept) 3.85e-03   1.25e-03    3.09    0.037 *  </span>
<span class="co">#&gt; spc         4.41e-04   2.87e-06  153.60  1.1e-08 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 0.00136 on 4 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:     1,   Adjusted R-squared:     1 </span>
<span class="co">#&gt; F-statistic: 2.36e+04 on 1 and 4 DF,  p-value: 1.08e-08</span>
</pre></div>
<p>In order to get predictions for new measurements, a new <code class="sourceCode r">data.frame</code> with the same independent variables (in columns with the same names) as in the calibration data are needed.
Then the function <code class="sourceCode r"><span class="kw">predict</span>()</code> can be used.
It can also calculate the prediction interval.
If we observe e.g. an intensity of 125 or 400 units, the corresponding concentrations and their 99% prediction intervals are:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="kw">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">125</span>, <span class="fl">400</span>)
<span class="kw">conc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">calibration</span>,
  newdata = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(spc = <span class="fu"><a href="../reference/as.data.frame.html">as.matrix</a></span>(<span class="kw">I</span>)), interval = <span class="st">"prediction"</span>,
  level = <span class="fl">.99</span>
)
<span class="kw">conc</span>
<span class="co">#&gt;        fit     lwr      upr</span>
<span class="co">#&gt; 1 0.058943 0.05133 0.066556</span>
<span class="co">#&gt; 2 0.180149 0.17338 0.186922</span>
</pre></div>
<p>Finally, we can draw the calibration function and its 99% confidence interval (also via <code class="sourceCode r"><span class="kw">predict</span>()</code>) together with the prediction example.
In order to draw the confidence interval into the calibration graph, we can either use a customized panel function:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="kw">int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(spc = <span class="fu"><a href="../reference/as.data.frame.html">as.matrix</a></span>(<span class="fu"><a href="../reference/seq.hyperSpec.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">flu</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">flu</span>), length.out = <span class="fl">25</span>)))
<span class="kw">ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">calibration</span>, newdata = <span class="kw">int</span>, interval = <span class="st">"confidence"</span>, level = <span class="fl">0.99</span>)

<span class="kw">panel.ci</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">...</span>, <span class="kw">intensity</span>, <span class="kw">ci.lwr</span>, <span class="kw">ci.upr</span>, <span class="kw">ci.col</span> = <span class="st">"#606060"</span>) {
  <span class="fu">panel.xyplot</span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">...</span>)
  <span class="fu">panel.lmline</span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">...</span>)
  <span class="fu">panel.lines</span>(<span class="kw">ci.lwr</span>, <span class="kw">intensity</span>, col = <span class="kw">ci.col</span>)
  <span class="fu">panel.lines</span>(<span class="kw">ci.upr</span>, <span class="kw">intensity</span>, col = <span class="kw">ci.col</span>)
}

<span class="fu"><a href="../reference/plotc.html">plotc</a></span>(<span class="kw">flu</span>,
  panel = <span class="kw">panel.ci</span>,
  intensity = <span class="kw">int</span><span class="op">$</span><span class="kw">spc</span>, ci.lwr = <span class="kw">ci</span>[, <span class="fl">2</span>], ci.upr = <span class="kw">ci</span>[, <span class="fl">3</span>]
)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:calplot3"></span>
<img src="flu_files/figure-html/calplot3-1.png" alt="Calibration function and its 99% confidence interval.  "><p class="caption">
Figure 4.3: Calibration function and its 99% confidence interval.
</p>
</div>
<p>Or, we can add the respective data to the <code class="sourceCode r">hyperSpec</code> object. The meaning of the data can be saved in a new extra data column that acts as grouping variable for the plot.</p>
<p>First, the spectral range of <code class="sourceCode r">flu</code> is cut to contain the fluorescence emission at 450 nm only, and the new column is introduced for the original data:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="kw">flu</span><span class="op">$</span><span class="kw">type</span> <span class="op">&lt;-</span> <span class="st">"data points"</span>
</pre></div>
<p>Next, the calculated confidence intervals are appended:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="kw">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initialize.html">new</a></span>(<span class="st">"hyperSpec"</span>,
  spc = <span class="fu"><a href="../reference/as.data.frame.html">as.matrix</a></span>(<span class="fu"><a href="../reference/seq.hyperSpec.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">flu</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">flu</span>), length.out = <span class="fl">25</span>)),
  wavelength = <span class="fl">450</span>
)
<span class="kw">ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">calibration</span>, newdata = <span class="kw">tmp</span><span class="op">$</span><span class="kw">.</span>, interval = <span class="st">"confidence"</span>, level = <span class="fl">0.99</span>)
<span class="kw">tmp</span> <span class="op">&lt;-</span> <span class="kw">tmp</span>[<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="../reference/seq.hyperSpec.html">seq</a></span>(<span class="kw">tmp</span>, index = <span class="fl">TRUE</span>), <span class="fl">3</span>)]
<span class="kw">tmp</span><span class="op">$</span><span class="kw">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">ci</span>)
<span class="kw">tmp</span><span class="op">$</span><span class="kw">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="../reference/dimnames,hyperSpec-method.html">colnames</a></span>(<span class="kw">ci</span>), each = <span class="fl">25</span>)

<span class="kw">flu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collapse.html">collapse</a></span>(<span class="kw">flu</span>, <span class="kw">tmp</span>)
</pre></div>
<p>Finally, the resulting object is plotted.
Our prediction example is handled by another customized panel function:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="kw">panel.predict</span> <span class="op">&lt;-</span>
  <span class="fu">function</span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">...</span>, <span class="kw">intensity</span>, <span class="kw">ci</span>, <span class="kw">pred.col</span> = <span class="st">"red"</span>, <span class="kw">pred.pch</span> = <span class="fl">19</span>, <span class="kw">pred.cex</span> = <span class="fl">1</span>) {
    <span class="fu">panel.xyplot</span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">...</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(<span class="fu">function</span>(<span class="kw">i</span>, <span class="kw">lwr</span>, <span class="kw">upr</span>, <span class="kw">...</span>) {
      <span class="fu">panel.lines</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">lwr</span>, <span class="kw">upr</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">i</span>, <span class="fl">2</span>), <span class="kw">...</span>)
    },
    <span class="kw">intensity</span>, <span class="kw">ci</span>[, <span class="fl">2</span>], <span class="kw">ci</span>[, <span class="fl">3</span>],
    MoreArgs = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(col = <span class="kw">pred.col</span>)
    )
    <span class="fu">panel.xyplot</span>(<span class="kw">ci</span>[, <span class="fl">1</span>], <span class="kw">intensity</span>, col = <span class="kw">pred.col</span>, pch = <span class="kw">pred.pch</span>, cex = <span class="kw">pred.cex</span>, type = <span class="st">"p"</span>)
  }

<span class="fu"><a href="../reference/plotc.html">plotc</a></span>(<span class="kw">flu</span>,
  groups = <span class="kw">type</span>, type = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"l"</span>, <span class="st">"p"</span>),
  col = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"black"</span>, <span class="st">"#606060"</span>, <span class="st">"#606060"</span>),
  pch = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">19</span>, <span class="fl">NA</span>, <span class="fl">NA</span>, <span class="fl">NA</span>),
  cex = <span class="fl">0.5</span>,
  lty = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>),
  panel = <span class="kw">panel.predict</span>,
  intensity = <span class="kw">I</span>,
  ci = <span class="kw">conc</span>,
  pred.cex = <span class="fl">0.5</span>
)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:calplot4"></span>
<img src="flu_files/figure-html/calplot4-1.png" alt="calibration function and its 99% confidence interval and predicted points. "><p class="caption">
Figure 4.4: calibration function and its 99% confidence interval and predicted points.
</p>
</div>
</div>
<div id="session-info" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session Info</h1>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="kw">sessioninfo</span>::<span class="fu"><a href="https://rdrr.io/pkg/sessioninfo/man/session_info.html">session_info</a></span>(<span class="st">"hyperSpec"</span>)
<span class="co">#&gt; ─ Session info ───────────────────────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt;  setting  value                       </span>
<span class="co">#&gt;  version  R version 4.0.2 (2020-06-22)</span>
<span class="co">#&gt;  os       macOS Catalina 10.15.6      </span>
<span class="co">#&gt;  system   x86_64, darwin17.0          </span>
<span class="co">#&gt;  ui       X11                         </span>
<span class="co">#&gt;  language (EN)                        </span>
<span class="co">#&gt;  collate  en_US.UTF-8                 </span>
<span class="co">#&gt;  ctype    en_US.UTF-8                 </span>
<span class="co">#&gt;  tz       UTC                         </span>
<span class="co">#&gt;  date     2020-08-23                  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ─ Packages ───────────────────────────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt;  package        * version  date       lib source        </span>
<span class="co">#&gt;  assertthat       0.2.1    2019-03-21 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  backports        1.1.8    2020-06-17 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  callr            3.4.3    2020-03-28 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  cli              2.0.2    2020-02-28 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  colorspace       1.4-1    2019-03-18 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  crayon           1.3.4    2017-09-16 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  desc             1.2.0    2018-05-01 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  digest           0.6.25   2020-02-23 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  dplyr            1.0.2    2020-08-18 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  ellipsis         0.3.1    2020-05-15 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  evaluate         0.14     2019-05-28 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  fansi            0.4.1    2020-01-08 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  farver           2.0.3    2020-01-16 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  generics         0.0.2    2018-11-29 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  ggplot2        * 3.3.2    2020-06-19 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  glue             1.4.1    2020-05-13 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  gtable           0.3.0    2019-03-25 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  hyperSpec      * 0.100.0  2020-08-23 [1] local         </span>
<span class="co">#&gt;  hySpc.testthat   0.2.1    2020-06-24 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  isoband          0.2.2    2020-06-20 [1] CRAN (R 4.0.1)</span>
<span class="co">#&gt;  jpeg             0.1-8.1  2019-10-24 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  labeling         0.3      2014-08-23 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  lattice        * 0.20-41  2020-04-02 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  latticeExtra     0.6-29   2019-12-19 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  lazyeval         0.2.2    2019-03-15 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  lifecycle        0.2.0    2020-03-06 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  magrittr         1.5      2014-11-22 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  MASS             7.3-51.6 2020-04-26 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  Matrix           1.2-18   2019-11-27 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  mgcv             1.8-31   2019-11-09 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  munsell          0.5.0    2018-06-12 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  nlme             3.1-148  2020-05-24 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  pillar           1.4.6    2020-07-10 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  pkgbuild         1.1.0    2020-07-13 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  pkgconfig        2.0.3    2019-09-22 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  pkgload          1.1.0    2020-05-29 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  png              0.1-7    2013-12-03 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  praise           1.0.0    2015-08-11 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  prettyunits      1.1.1    2020-01-24 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  processx         3.4.3    2020-07-05 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  ps               1.3.4    2020-08-11 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  purrr            0.3.4    2020-04-17 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  R6               2.4.1    2019-11-12 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  RColorBrewer     1.1-2    2014-12-07 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  rlang            0.4.7    2020-07-09 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  rprojroot        1.3-2    2018-01-03 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  rstudioapi       0.11     2020-02-07 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  scales           1.1.1    2020-05-11 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  testthat         2.3.2    2020-03-02 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  tibble           3.0.3    2020-07-10 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  tidyselect       1.1.0    2020-05-11 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  utf8             1.1.4    2018-05-24 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  vctrs            0.3.2    2020-07-15 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  viridisLite      0.3.0    2018-02-01 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  withr            2.2.0    2020-04-20 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  xml2             1.3.2    2020-04-23 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [1] /Users/runner/work/_temp/Library</span>
<span class="co">#&gt; [2] /Library/Frameworks/R.framework/Versions/4.0/Resources/library</span>
</pre></div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Claudia Beleites, Valter Sergo.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
