<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raman Spectra of Chondrocytes in Cartilage • hyperSpec</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Raman Spectra of Chondrocytes in Cartilage">
<meta property="og:description" content="chondro: Example workflow for 2D Raman spectra dataset `chondro`.">
<meta name="robots" content="noindex">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hyperSpec</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.99-20200615</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Documentation for version of package:</li>
    <li>
      <a href="https://cbeleites.github.io/hyperSpec/">Released</a>
    </li>
    <li>
      <a href="https://cbeleites.github.io/hyperSpec/dev/">In-development</a>
    </li>
  </ul>
</li>
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/hyperSpec.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/fileio.html">Import and Export Files with Spectra</a>
    </li>
    <li>
      <a href="../articles/plotting.html">Plotting Functions in "hyperSpec"</a>
    </li>
    <li>
      <a href="../articles/baseline.html">Fitting Baselines to Spectra</a>
    </li>
    <li class="divider">
    <li>
      <a href="../articles/index.html">More...</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cbeleites/hyperSpec/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="chondro_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Raman Spectra of Chondrocytes in Cartilage</h1>
            <h3 class="subtitle">Example Workflow for 2D Raman Spectra Dataset <code>chondro</code>
</h3>
                        <h4 class="author">Claudia Beleites<sup>1,2,3,4,5</sup>, Vilmantas Gegzna</h4>
            <address class="author_afil">
      <ol style="list-style-type: decimal">
<li>DIA Raman Spectroscopy Group, University of Trieste/Italy (2005–2008)</li>
      <li>Spectroscopy <span class="math inline">\(\cdot\)</span> Imaging, IPHT, Jena/Germany (2008–2017)</li>
      <li>ÖPV, JKI, Berlin/Germany (2017–2019)</li>
      <li>Arbeitskreis Lebensmittelmikrobiologie und Biotechnologie, Hamburg University, Hamburg/Germany (2019 – 2020)</li>
      <li>Chemometric Consulting and Chemometrix GmbH, Wölfersheim/Germany (since 2016)</li>
      </ol>
<br><a class="author_email" href="mailto:#"></a><a href="mailto:chemometrie@beleites.de" class="email">chemometrie@beleites.de</a>
      </address>
                  
            <h4 class="date">2020-07-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cbeleites/hyperSpec/blob/master/../vignettes/chondro.Rmd"><code>../vignettes/chondro.Rmd</code></a></small>
      <div class="hidden name"><code>chondro.Rmd</code></div>

    </div>

    
    
<!-- ======================================================================= -->
<!-- ======================================================================= -->
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a><span class="header-section-number">1</span> Introduction</h1>
<p>This vignette describes the <code class="sourceCode r">chondro</code> data set.
It shows a complete data analysis work flow on a Raman map demonstrating frequently needed preprocessing methods:</p>
<ul>
<li>baseline correction,</li>
<li>normalization,</li>
<li>smoothing / interpolating spectra,</li>
<li>preprocessing the spatial grid,</li>
</ul>
<p>as well as other basic work techniques:</p>
<ul>
<li>plotting spectra,</li>
<li>plotting false color maps,</li>
<li>cutting the spectral range,</li>
<li>selecting (extracting) or deleting spectra, and</li>
<li>
<em>aggregating</em> spectra (e.g. calculating cluster mean spectra).</li>
</ul>
<p>The chemometric methods used are:</p>
<ul>
<li>Principal Component Analysis (PCA) and</li>
<li>Hierarchical Cluster Analysis,</li>
</ul>
<p>showing how to use data analysis procedures provided by R and other
packages.</p>
</div>
<div id="the-data-set" class="section level1">
<h1 class="hasAnchor">
<a href="#the-data-set" class="anchor"></a><span class="header-section-number">2</span> The Data Set</h1>
<p>Raman spectra of a cartilage section were measured on each point of a grid, resulting in a so-called
<em>Raman map</em>.
Figure <a href="#fig:vis-all">2.1</a> shows a microscope picture of the measured area and its
surroundings.</p>
<div class="figure" style="text-align: center">
<span id="fig:vis-all"></span>
<img src="chondro--080606d-flip-ausw.jpg" alt="
Microphotograph of the cartilage section.
The frame indicates the measurement area of $35×25 \mu m.$
" width="400"><p class="caption">
Figure 2.1: 
Microphotograph of the cartilage section.
The frame indicates the measurement area of <span class="math inline">\(35×25 \mu m.\)</span>
</p>
</div>
<p>The measurement parameters were:</p>
<ul>
<li>
<strong>Excitation wavelength:</strong> 633 nm</li>
<li>
<strong>Exposure time:</strong> 10 s per spectrum</li>
<li>
<strong>Objective:</strong> 100×, NA 0.85</li>
<li>
<strong>Measurement grid:</strong> 35 × 25 <span class="math inline">\(\mu m\)</span>, 1 <span class="math inline">\(\mu m\)</span> step size</li>
<li>
<strong>Spectrometer:</strong> Renishaw InVia</li>
</ul>
</div>
<div id="data-import" class="section level1">
<h1 class="hasAnchor">
<a href="#data-import" class="anchor"></a><span class="header-section-number">3</span> Data Import</h1>
<p>Renishaw provides a converter to export their proprietary data in a so-called long format ASCII file. Raman maps are exported having four columns, <em>y</em>, <em>x</em>, <em>raman shift</em>, and <em>intensity</em>.
Package <strong>hyperSpec</strong> comes with a function to import such files, <code class="sourceCode r"><span class="kw">read.txt.Renishaw</span>()</code>.
The function assumes a map as default, but can also handle single spectra (<code class="sourceCode r">data =<span class="st"> "spc"</span></code>), time series (<code class="sourceCode r">data =<span class="st"> "ts"</span></code>), and depth profiles (<code class="sourceCode r">data =<span class="st"> "depth"</span></code>).
In addition, large files may be processed in chunks.
In order to speed up the reading <code class="sourceCode r"><span class="kw">read.txt.Renishaw</span>()</code> does not allow missing values, but it does work with <code class="sourceCode r"><span class="ot">NA</span></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># Download file from:</span>
<span class="kw">raw_data_url</span> <span class="op">&lt;-</span>
  <span class="st">"https://media.githubusercontent.com/media/cbeleites/hyperSpec/master/Vignettes/fileio/txt.Renishaw/chondro.gz"</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="st">"rawdata"</span>, showWarnings = <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(<span class="kw">raw_data_url</span>, <span class="st">"rawdata/chondro.gz"</span>)

<span class="co"># Read the raw data and make a hyperSpec object</span>
<span class="kw">chondro</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.txt.Renishaw.html">read.txt.Renishaw</a></span>(<span class="st">"rawdata/chondro.gz"</span>, data = <span class="st">"xyspc"</span>)
<span class="kw">chondro</span>
<span class="co">#&gt; hyperSpec object</span>
<span class="co">#&gt;    875 spectra</span>
<span class="co">#&gt;    4 data columns</span>
<span class="co">#&gt;    1272 data points / spectrum</span>
<span class="co">#&gt; wavelength: Delta * tilde(nu)/cm^-1 [numeric] 601.62 602.66 ... 1802.2 </span>
<span class="co">#&gt; data:  (875 rows x 4 columns)</span>
<span class="co">#&gt;    1. y: y/(mu * m) [numeric] -4.77 -4.77 ... 19.23 </span>
<span class="co">#&gt;    2. x: x/(mu * m) [numeric] -11.55 -10.55 ... 22.45 </span>
<span class="co">#&gt;    3. spc: I / a.u. [matrix, array1272] 501.72 518.53 ... 151.92 + NA</span>
<span class="co">#&gt;    4. filename: filename [character] rawdata/chondro.gz rawdata/chondro.gz ... rawdata/chondro.gz</span>
</pre></div>
<p>To get an overview of the spectra (figure <a href="#fig:rawspc">3.1</a>):</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">chondro</span>, <span class="st">"spcprctl5"</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:rawspc"></span>
<img src="chondro_files/figure-html/rawspc-1.png" alt="The raw spectra: median, 16^th^ and 84^th^, and 5^th^ and 95^th^ percentile
spectra."><p class="caption">
Figure 3.1: The raw spectra: median, 16<sup>th</sup> and 84<sup>th</sup>, and 5<sup>th</sup> and 95<sup>th</sup> percentile
spectra.
</p>
</div>
<p>A mean intensity map (figure <a href="#fig:rawmap">3.2</a>) is produced by:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># Set a color palette</span>
<span class="kw">seq_palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"white"</span>, <span class="st">"dark green"</span>), space = <span class="st">"Lab"</span>)
</pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">chondro</span>, func.args = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(na.rm = <span class="fl">TRUE</span>), col.regions = <span class="fu">seq_palette</span>(<span class="fl">20</span>))
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:rawmap"></span>
<img src="chondro_files/figure-html/rawmap-1.png" alt="The sum intensity of the raw spectra."><p class="caption">
Figure 3.2: The sum intensity of the raw spectra.
</p>
</div>
<p>Function <code class="sourceCode r"><span class="kw">plotmap</span>()</code> squeezes all spectral intensities into a summary characteristic for the whole spectrum.
This function defaults to the <code class="sourceCode r"><span class="kw">mean</span>()</code>.
Further arguments that should be handed to this function can be given in list <code class="sourceCode r">func.args</code>.
As the raw data contains <code class="sourceCode r"><span class="ot">NA</span></code>s due to deleting cosmic ray spikes, this argument is needed here.</p>
</div>
<div id="preprocessing" class="section level1">
<h1 class="hasAnchor">
<a href="#preprocessing" class="anchor"></a><span class="header-section-number">4</span> Preprocessing</h1>
<p>As usual in Raman spectroscopy of biological tissues, the spectra need some preprocessing.</p>
<div id="aligning-the-spatial-grid" class="section level2">
<h2 class="hasAnchor">
<a href="#aligning-the-spatial-grid" class="anchor"></a><span class="header-section-number">4.1</span> Aligning the Spatial Grid</h2>
<p>The spectra were acquired on a regular square grid of measurement positions over the sample.
The <code class="sourceCode r">hyperSpec</code> object, however, does not store the data on this grid but rather stores the position where the spectra were taken.
This allows more handling of irregular point patterns, and of sparse measurements where not a
complete (square) is retained but only few positions on this grid.</p>
<p>Occasionally, numeric or rounding errors will lead to seemingly irregular spacing of the data
points.
This is most obvious in false-colour maps of the sample (fig. <a href="#fig:rawmap">3.2</a>, as <code class="sourceCode r">plotmap</code> by default uses <code class="sourceCode r">panel.levelplot.raster</code>, which assumes a regular grid is underlying the data.
The symptoms are warnings “<code>'x' values are not equispaced; output may be wrong</code>” and white stripes in the false colour map (fig. <a href="#fig:irregular-a">4.1</a>), which occur even thought the points are almost at their correct place (fig. <a href="#fig:irregular-b">4.2</a>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co">## disturb a few points</span>
<span class="kw">chondro</span><span class="op">$</span><span class="kw">x</span>[<span class="fl">500</span>] <span class="op">&lt;-</span> <span class="kw">chondro</span><span class="op">$</span><span class="kw">x</span>[<span class="fl">500</span>] <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1</span>, sd = <span class="fl">0.01</span>)
<span class="kw">chondro</span><span class="op">$</span><span class="kw">y</span>[<span class="fl">660</span>] <span class="op">&lt;-</span> <span class="kw">chondro</span><span class="op">$</span><span class="kw">y</span>[<span class="fl">660</span>] <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1</span>, sd = <span class="fl">0.01</span>)
</pre></div>
<!-- irregular-grid ------------------------------------------------------ -->
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">chondro</span>, col.regions = <span class="fu">seq_palette</span>(<span class="fl">20</span>))
<span class="co">#&gt; Warning in (function (x, y, z, subscripts, at = pretty(z), ..., col.regions = regions$col, : 'x'</span>
<span class="co">#&gt; values are not equispaced; output may be wrong</span>
<span class="co">#&gt; Warning in (function (x, y, z, subscripts, at = pretty(z), ..., col.regions = regions$col, : 'y'</span>
<span class="co">#&gt; values are not equispaced; output may be wrong</span>
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:irregular-a"></span>
<img src="chondro_files/figure-html/irregular-a-1.png" alt="
Rounding erros in the point coordinates of lateral measurement grid:
**(A)** off-grid points cause stripes.
"><p class="caption">
Figure 4.1: 
Rounding erros in the point coordinates of lateral measurement grid:
<strong>(A)</strong> off-grid points cause stripes.
</p>
</div>
<!-- --------------------------------------------------------------------- -->
<!-- irregular-pts ------------------------------------------------------- -->
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st"><a href="http://latticeextra.r-forge.r-project.org">"latticeExtra"</a></span>)
<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">chondro</span>,
  col.regions = <span class="fu">seq_palette</span>(<span class="fl">20</span>), panel = <span class="kw">panel.levelplot.points</span>,
  col = <span class="fl">NA</span>, pch = <span class="fl">22</span>, cex = <span class="fl">1.9</span>
)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:irregular-b"></span>
<img src="chondro_files/figure-html/irregular-b-1.png" alt="
Rounding erros in the point coordinates of lateral measurement grid:
**(B)** slightly wrong coordinages.
"><p class="caption">
Figure 4.2: 
Rounding erros in the point coordinates of lateral measurement grid:
<strong>(B)</strong> slightly wrong coordinages.
</p>
</div>
<!-- --------------------------------------------------------------------- -->
<p>Such slight rounding errors can be corrected by <code class="sourceCode r"><span class="kw">fitraster</span>()</code> or <code class="sourceCode r"><span class="kw">makeraster</span>()</code>.
Function <code class="sourceCode r"><span class="kw">fitraster</span>()</code> needs the step size of the raster and a starting coordinate, whereas <code class="sourceCode r"><span class="kw">makeraster</span>()</code> tries to guess these parameters for <code class="sourceCode r"><span class="kw">fitraster</span>()</code>.
As long as just a few points are affected by rounding errors, <code class="sourceCode r"><span class="kw">makeraster</span>()</code> works fine:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">chondro</span><span class="op">$</span><span class="kw">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeraster.html">fitraster</a></span>(<span class="kw">chondro</span><span class="op">$</span><span class="kw">x</span>)<span class="op">$</span><span class="kw">x</span>
<span class="kw">chondro</span><span class="op">$</span><span class="kw">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeraster.html">fitraster</a></span>(<span class="kw">chondro</span><span class="op">$</span><span class="kw">y</span>)<span class="op">$</span><span class="kw">x</span>
</pre></div>
<p>the result is shown in figure <a href="#fig:irregular-c">4.3</a>.</p>
<!-- irregular-corr  ------------------------------------------------------ -->
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">chondro</span>, col.regions = <span class="fu">seq_palette</span>(<span class="fl">20</span>))
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:irregular-c"></span>
<img src="chondro_files/figure-html/irregular-c-1.png" alt="
Rounding erros in the point coordinates of lateral measurement grid:
**(C)** corrected grid.
"><p class="caption">
Figure 4.3: 
Rounding erros in the point coordinates of lateral measurement grid:
<strong>(C)</strong> corrected grid.
</p>
</div>
<!-- --------------------------------------------------------------------- -->
<!-- The subplots -------------------------------------------------------- -->
<div class="figure" style="text-align: center">
<span id="fig:irregular"></span>
<img src="chondro_files/figure-html/irregular-1.png" alt="
Rounding erros in the point coordinates of lateral measurement grid.
**(A)** Off-grid points cause stripes.
**(B)** Slightly wrong coordinages.
**(C)** Corrected grid.  " width="98%"><p class="caption">
Figure 4.4: 
Rounding erros in the point coordinates of lateral measurement grid.
<strong>(A)</strong> Off-grid points cause stripes.
<strong>(B)</strong> Slightly wrong coordinages.
<strong>(C)</strong> Corrected grid.
</p>
</div>
<!-- --------------------------------------------------------------------- -->
<!-- ===================================================================== -->
<!-- ===================================================================== -->
</div>
<div id="spectral-smoothing" class="section level2">
<h2 class="hasAnchor">
<a href="#spectral-smoothing" class="anchor"></a><span class="header-section-number">4.2</span> Spectral Smoothing</h2>
<p>As the overview shows that the spectra contain <code class="sourceCode r"><span class="ot">NA</span></code>s (from cosmic spike removal that was done previously), the first step is to remove these.
Also, the wavelength axis of the raw spectra is not evenly spaced (the data points are between 0.85 and 1 <span class="math inline">\(cm^{-1}\)</span> apart from each other).
Furthermore, it would be good to trade some spectral resolution for higher signal to noise ratio.
All three of these issues are tackled by interpolating and smoothing of the wavelength axis by <code class="sourceCode r"><span class="kw">spc.loess</span>()</code>.
The resolution is to be reduced to 8 <span class="math inline">\(cm^{-1}\)</span>, or 4 <span class="math inline">\(cm^{-1}\)</span> data point spacing.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">chondro</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spc.loess.html">spc.loess</a></span>(<span class="kw">chondro</span>, <span class="fu"><a href="../reference/seq.hyperSpec.html">seq</a></span>(<span class="fl">602</span>, <span class="fl">1800</span>, <span class="fl">4</span>))
<span class="kw">chondro</span>
<span class="co">#&gt; hyperSpec object</span>
<span class="co">#&gt;    875 spectra</span>
<span class="co">#&gt;    4 data columns</span>
<span class="co">#&gt;    300 data points / spectrum</span>
<span class="co">#&gt; wavelength: Delta * tilde(nu)/cm^-1 [numeric] 602 606 ... 1798 </span>
<span class="co">#&gt; data:  (875 rows x 4 columns)</span>
<span class="co">#&gt;    1. y: y [numeric] -4.77 -4.77 ... 19.23 </span>
<span class="co">#&gt;    2. x: x [numeric] -11.55 -10.55 ... 22.45 </span>
<span class="co">#&gt;    3. spc: I / a.u. [matrix, array300] 517.03 499.77 ... 168.04 </span>
<span class="co">#&gt;    4. filename: filename [character] rawdata/chondro.gz rawdata/chondro.gz ... rawdata/chondro.gz</span>
</pre></div>
<p>The spectra are now the same as in the data set <code class="sourceCode r">chondro</code>.
However, the data set also contains the clustering results (see at the very end of this document).
They are stored for saving as the distributed demo data:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">spectra_to_save</span> <span class="op">&lt;-</span> <span class="kw">chondro</span>
</pre></div>
</div>
<div id="baseline-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#baseline-correction" class="anchor"></a><span class="header-section-number">4.3</span> Baseline Correction</h2>
<p>The next step is a linear baseline correction. <code class="sourceCode r"><span class="kw">spc.fit.poly.below</span>()</code> tries to automatically find appropriate support points for polynomial baselines.
The default is a linear baseline, which is appropriate in our case:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="kw">baselines</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spc.fit.poly.html">spc.fit.poly.below</a></span>(<span class="kw">chondro</span>)
<span class="kw">chondro</span> <span class="op">&lt;-</span> <span class="kw">chondro</span> <span class="op">-</span> <span class="kw">baselines</span>
</pre></div>
</div>
<div id="normalization" class="section level2">
<h2 class="hasAnchor">
<a href="#normalization" class="anchor"></a><span class="header-section-number">4.4</span> Normalization</h2>
<p>As the spectra are quite similar, area normalization should work well:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">chondro</span> <span class="op">&lt;-</span> <span class="kw">chondro</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="kw">chondro</span>)
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">chondro</span>, <span class="st">"spcprctl5"</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:bl-norm"></span>
<img src="chondro_files/figure-html/bl-norm-1.png" alt="The spectra after smoothing, baseline correction, and normalization.  "><p class="caption">
Figure 4.5: The spectra after smoothing, baseline correction, and normalization.
</p>
</div>
<p>Note that normalization effectively cancels the information of one variate (wavelength), it introduces a collinearity.
If needed, this collinearity can be broken by removing one of the variates involved in the normalization.
Note that the <code class="sourceCode r">chondro</code> object shipped with package <strong>hyperSpec</strong> set has multiple collinearities as only the first 10 principal components are shipped (see below).</p>
<p>For the results of these preprocessing steps, see figure <a href="#fig:bl-norm">4.5</a>.</p>
</div>
<div id="subtracting-the-overall-composition" class="section level2">
<h2 class="hasAnchor">
<a href="#subtracting-the-overall-composition" class="anchor"></a><span class="header-section-number">4.5</span> Subtracting the Overall Composition</h2>
<p>The spectra are very homogeneous, but I’m interested in the differences between the different regions of the sample.
Subtracting the minimum spectrum cancels out the matrix composition that is common to all spectra.
But the minimum spectrum also picks up a lot of noise.
So instead, the 5<sup>th</sup> percentile spectrum is subtracted:</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="kw">chondro</span> <span class="op">&lt;-</span> <span class="kw">chondro</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">chondro</span>, <span class="fl">0.05</span>)
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">chondro</span>, <span class="st">"spcprctl5"</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:bl-perc"></span>
<img src="chondro_files/figure-html/bl-perc-1.png" alt="The spectra after subtracting the 5^th^ percentile spectrum.  "><p class="caption">
Figure 4.6: The spectra after subtracting the 5<sup>th</sup> percentile spectrum.
</p>
</div>
<p>The resulting data set is shown in figure <a href="#fig:bl-perc">4.6</a>.
Some interesting differences start to show up: there are distinct lipid bands in some but not all of the spectra.</p>
</div>
<div id="outlier-removal-by-principal-component-analysis-pca" class="section level2">
<h2 class="hasAnchor">
<a href="#outlier-removal-by-principal-component-analysis-pca" class="anchor"></a><span class="header-section-number">4.6</span> Outlier Removal by Principal Component Analysis (PCA)</h2>
<p>PCA is a technique that decomposes the data into scores and loadings (virtual spectra).
It is known to be quite sensitive to outliers.
Thus, I use it for outlier detection. The resulting scores and loadings are put again into <code class="sourceCode r">hyperSpec</code> objects by <code class="sourceCode r"><span class="kw">decomposition</span>()</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="kw">pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span>(<span class="kw">chondro</span>, center = <span class="fl">TRUE</span>)

<span class="kw">scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/decomposition.html">decomposition</a></span>(<span class="kw">chondro</span>, <span class="kw">pca</span><span class="op">$</span><span class="kw">x</span>,
  label.wavelength = <span class="st">"PC"</span>,
  label.spc = <span class="st">"score / a.u."</span>
)

<span class="kw">loadings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/decomposition.html">decomposition</a></span>(<span class="kw">chondro</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">pca</span><span class="op">$</span><span class="kw">rotation</span>),
  scores = <span class="fl">FALSE</span>,
  label.spc = <span class="st">"loading I / a.u."</span>
)
</pre></div>
<p>Plotting the scores of each PC against all other gives a good idea where to look for outliers.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span>(<span class="kw">scores</span>[[, , <span class="fl">1</span><span class="op">:</span><span class="fl">7</span>]], pch = <span class="fl">19</span>, cex = <span class="fl">0.5</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:pca-pairs"></span>
<img src="chondro_files/figure-html/pca-pairs-1.png" alt="The `pairs()`{.r} plot of the first 7 scores. "><p class="caption">
Figure 4.7: The <code class="sourceCode r"><span class="kw">pairs</span>()</code> plot of the first 7 scores.
</p>
</div>
<p>Now the spectra can be found either by plotting two scores against each other (by <code class="sourceCode r"><span class="kw">plot</span>()</code>) and identifying with <code class="sourceCode r"><span class="kw">identify</span>()</code>, or they can be identified in the score map by <code class="sourceCode r"><span class="kw">map.identify</span>()</code>.
There is also a function to identify spectra in a spectra plot, <code class="sourceCode r"><span class="kw">spc.identify</span>()</code>, which could be used to identify principal components that are heavily influenced, e.g., by cosmic ray spikes.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="co">## omit the first 4 PCs</span>
<span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plotmap.html">map.identify</a></span>(<span class="kw">scores</span> [, , <span class="fl">5</span>])
<span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">out</span>, <span class="fu"><a href="../reference/plotmap.html">map.identify</a></span>(<span class="kw">scores</span> [, , <span class="fl">6</span>]))
<span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">out</span>, <span class="fu"><a href="../reference/plotmap.html">map.identify</a></span>(<span class="kw">scores</span> [, , <span class="fl">7</span>]))
</pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="kw">out</span>
<span class="co">#&gt; [1] 105 140 216 289  75  69</span>
<span class="kw">outcols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"#800080"</span>, <span class="st">"orange"</span>, <span class="st">"magenta"</span>, <span class="st">"brown"</span>)

<span class="kw">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"black"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">chondro</span>))
<span class="kw">cols</span>[<span class="kw">out</span>] <span class="op">&lt;-</span> <span class="kw">outcols</span>
</pre></div>
<p>We can check our findings by comparing the spectra to the bulk of spectra (figure <a href="#fig:pca-outspc">4.8</a>):</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">chondro</span>[<span class="fl">1</span>],
  plot.args = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(ylim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">out</span>) <span class="op">+</span> <span class="fl">.7</span>)),
  lines.args = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(type = <span class="st">"n"</span>)
)

<span class="co">for</span> (<span class="kw">i</span> <span class="co">in</span> <span class="fu"><a href="../reference/seq.hyperSpec.html">seq</a></span>(along = <span class="kw">out</span>)) {
  <span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">chondro</span>, <span class="st">"spcprctl5"</span>, yoffset = <span class="kw">i</span>, add = <span class="fl">TRUE</span>, col = <span class="st">"gray"</span>)
  <span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">chondro</span>[<span class="kw">out</span>[<span class="kw">i</span>]],
    yoffset = <span class="kw">i</span>, col = <span class="kw">outcols</span>[<span class="kw">i</span>], add = <span class="fl">TRUE</span>,
    lines.args = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(lwd = <span class="fl">2</span>)
  )
  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(<span class="fl">600</span>, <span class="kw">i</span> <span class="op">+</span> <span class="fl">.33</span>, <span class="kw">out</span>[<span class="kw">i</span>])
}
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:pca-outspc"></span>
<img src="chondro_files/figure-html/pca-outspc-1.png" alt="The suspected outlier spectra. "><p class="caption">
Figure 4.8: The suspected outlier spectra.
</p>
</div>
<p>and also by looking where these spectra appear in the scores <code class="sourceCode r"><span class="kw">pairs</span>()</code> plot (figure <a href="#fig:pca-pairs-2">4.9</a>):</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="kw">pch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">46L</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">chondro</span>))
<span class="kw">pch</span>[<span class="kw">out</span>] <span class="op">&lt;-</span> <span class="fl">19L</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span>(<span class="kw">scores</span>[[, , <span class="fl">1</span><span class="op">:</span><span class="fl">7</span>]], pch = <span class="kw">pch</span>, cex = <span class="fl">1</span>, col = <span class="kw">cols</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:pca-pairs-2"></span>
<img src="chondro_files/figure-html/pca-pairs-2-1.png" alt="The `pairs()`{.r} plot of the first 7 scores with suspected outliers. "><p class="caption">
Figure 4.9: The <code class="sourceCode r"><span class="kw">pairs</span>()</code> plot of the first 7 scores with suspected outliers.
</p>
</div>
<!-- ```{r pca-pairs2} -->
<!-- png("chondro-fig--pca-pairs2.png", width = 500, height = 500) -->
<!-- pch <- rep(46L, nrow(chondro)) -->
<!-- pch[out] <- 19L -->
<!-- pairs(scores[[, , 1:7]], pch = pch, cex = 1, col = cols) -->
<!-- dev.off() -->
<!-- ``` -->
<p>Finally, the outliers are removed:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="kw">chondro</span> <span class="op">&lt;-</span> <span class="kw">chondro</span>[<span class="op">-</span><span class="kw">out</span>]
</pre></div>
</div>
</div>
<div id="hierarchical-cluster-analysis-hca" class="section level1">
<h1 class="hasAnchor">
<a href="#hierarchical-cluster-analysis-hca" class="anchor"></a><span class="header-section-number">5</span> Hierarchical Cluster Analysis (HCA)</h1>
<p>HCA merges objects according to their (dis)similarity into clusters. The result is
a dendrogram, a graph stating at which level two objects are similar
and thus grouped together.</p>
<p>The first step in HCA is the choice of the distance.
The R function <code class="sourceCode r"><span class="kw">dist</span>()</code> offers a variety of distance measures to be computed.
The so-called <strong>Pearson</strong> distance <span class="math inline">\(D^2_{Pearson}=\frac{1-\mathrm{COR}\left(X\right)}{2}\)</span> is popular in data analysis of vibrational spectra and is provided by package <strong>hyperSpec</strong>’s <code class="sourceCode r"><span class="kw">pearson.dist</span>()</code> function.</p>
<p>Also for computing the dendrogram, a number of choices are available.
Here we choose <strong>Ward</strong>’s method, and, as it uses <strong>Euclid</strong>ean distance for calculating the dendrogram, <strong>Euclid</strong>ean distance also for the distance matrix:</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="kw">dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="kw">chondro</span>)
<span class="kw">dendrogram</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="kw">dist</span>, method = <span class="st">"ward.D2"</span>)
</pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">dendrogram</span>, labels = <span class="fl">FALSE</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:denddummy"></span>
<img src="chondro_files/figure-html/denddummy-1.png" alt="Dendogram. "><p class="caption">
Figure 5.1: Dendogram.
</p>
</div>
<p>In order to get clusters, the dendrogram is cut at a level specified either by height or by the number of clusters.</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="kw">chondro</span><span class="op">$</span><span class="kw">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span>(<span class="kw">dendrogram</span>, k = <span class="fl">3</span>))
<span class="kw">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"dark blue"</span>, <span class="st">"orange"</span>, <span class="st">"#C02020"</span>)
</pre></div>
<p>The result for <span class="math inline">\(k\)</span> = 3 clusters is plotted as a map (figure <a href="#fig:clustmap">5.2</a>).
If the color-coded variate (left hand side of the formula) is a factor, the legend bar does not show intermediate colors, and <code class="sourceCode r">hyperSpec</code>’s <code class="sourceCode r"><span class="kw">levelplot</span>()</code> method uses the levels of the factor for the legend.</p>
<p>Thus meaningful names are assigned</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="kw">chondro</span><span class="op">$</span><span class="kw">clusters</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"matrix"</span>, <span class="st">"lacuna"</span>, <span class="st">"cell"</span>)
</pre></div>
<p>and the cluster membership map is plotted:</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="fu"><a href="../reference/as.character,hyperSpec-method.html">print</a></span>(<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">chondro</span>, <span class="kw">clusters</span> <span class="op">~</span> <span class="kw">x</span> <span class="op">*</span> <span class="kw">y</span>, col.regions = <span class="kw">cols</span>))
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:clustmap"></span>
<img src="chondro_files/figure-html/clustmap-1.png" alt="Hierarchical cluster analysis: the cluster map for $k=3$ clusters. "><p class="caption">
Figure 5.2: Hierarchical cluster analysis: the cluster map for <span class="math inline">\(k=3\)</span> clusters.
</p>
</div>
<p>The cluster membership can also be marked in the dendrogram:</p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(xpd = <span class="fl">TRUE</span>) <span class="co"># allow plotting the markers into the margin</span>
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">dendrogram</span>, labels = <span class="fl">FALSE</span>, hang = <span class="op">-</span><span class="fl">1</span>)
<span class="fu"><a href="../reference/mark.dendrogram.html">mark.dendrogram</a></span>(<span class="kw">dendrogram</span>, <span class="kw">chondro</span><span class="op">$</span><span class="kw">clusters</span>, col = <span class="kw">cols</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:dend"></span>
<img src="chondro_files/figure-html/dend-1.png" alt="Hierarchical cluster analysis: the dendrogram."><p class="caption">
Figure 5.3: Hierarchical cluster analysis: the dendrogram.
</p>
</div>
<p>Figure <a href="#fig:dend">5.3</a> shows the dendrogram and <a href="#fig:clustmap">5.2</a> the resulting cluster map.
The three clusters correspond to the cartilage matrix, the lacuna and the cells.
The left cell is destroyed and its contents are leaking into the matrix, while the right cells looks intact.</p>
<p>We can plot the cluster mean spectra <span class="math inline">\(\pm\)</span> 1 standard deviation using <code class="sourceCode r"><span class="kw">aggregate</span>()</code> (see figure <a href="#fig:clustmeans">5.4</a>):</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="kw">cluster.means</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate.html">aggregate</a></span>(<span class="kw">chondro</span>, <span class="kw">chondro</span><span class="op">$</span><span class="kw">clusters</span>, <span class="kw">mean_pm_sd</span>)

<span class="kw">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(las = <span class="fl">1</span>, mar = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">1</span>), mgp = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">0</span>))
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">cluster.means</span>, stacked = <span class="st">".aggregate"</span>, fill = <span class="st">".aggregate"</span>, col = <span class="kw">cols</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:clustmeans"></span>
<img src="chondro_files/figure-html/clustmeans-1.png" alt="The cluster mean $\pm$ 1 standard deviation spectra.
The blue cluster shows distinct lipid bands, the yellow cluster collagen, and the red cluster proteins and nucleic acids.  "><p class="caption">
Figure 5.4: The cluster mean <span class="math inline">\(\pm\)</span> 1 standard deviation spectra.
The blue cluster shows distinct lipid bands, the yellow cluster collagen, and the red cluster proteins and nucleic acids.
</p>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">op</span>)
</pre></div>
</div>
<div id="plotting-a-false-colour-map-of-certain-spectral-regions" class="section level1">
<h1 class="hasAnchor">
<a href="#plotting-a-false-colour-map-of-certain-spectral-regions" class="anchor"></a><span class="header-section-number">6</span> Plotting a False-Colour Map of Certain Spectral Regions</h1>
<p>Package <code class="sourceCode r">hyperSpec</code> comes with a sophisticated interface for specifying spectral ranges.
Expressing things like 1000<span class="math inline">\(cm^{-1}\)</span> <span class="math inline">\(\pm\)</span> 1 data points is easily possible.
Thus, we can have a fast look at the nucleic acid distribution, using the DNA bands at 728, 782, 1098, 1240, 1482, and 1577 <span class="math inline">\(cm^{-1}:\)</span></p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="kw">DNAcols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"white"</span>, <span class="st">"gold"</span>, <span class="st">"dark green"</span>), space = <span class="st">"Lab"</span>)(<span class="fl">20</span>)
<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">chondro</span>[, , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">728</span>, <span class="fl">782</span>, <span class="fl">1098</span>, <span class="fl">1240</span>, <span class="fl">1482</span>, <span class="fl">1577</span>)],
  col.regions = <span class="kw">DNAcols</span>
)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:DNA"></span>
<img src="chondro_files/figure-html/DNA-1.png" alt="False color map of DNA.  "><p class="caption">
Figure 6.1: False color map of DNA.
</p>
</div>
<p>The result is shown in figure <a href="#fig:DNA">6.1</a>.
While the nucleus of the right cell shows up nicely, only low concentration remainders are detected of the left cell.</p>
</div>
<div id="smoothed-false-colour-maps-and-interpolation" class="section level1">
<h1 class="hasAnchor">
<a href="#smoothed-false-colour-maps-and-interpolation" class="anchor"></a><span class="header-section-number">7</span> Smoothed False-Colour Maps and Interpolation</h1>
<p>As we plotted only a few selected wavelenths, figure <a href="#fig:DNA">6.1</a> is quite noisy.
Smoothing interpolation could help.
In R, such a smoother is mostly seen as a model, whose predictions are then displayed as smooth map (fig. <a href="#fig:DNAsm">7.1</a>).
This smoothing model can be calculated on the fly, e.g., by using the <code class="sourceCode r"><span class="kw">panel.2dsmoother</span>()</code> wrapper provided by package <strong>latticeExtra</strong>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">chondro</span>[, , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">728</span>, <span class="fl">782</span>, <span class="fl">1098</span>, <span class="fl">1240</span>, <span class="fl">1482</span>, <span class="fl">1577</span>)],
  col.regions = <span class="kw">DNAcols</span>,
  panel = <span class="kw">panel.2dsmoother</span>, args = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(span = <span class="fl">0.05</span>)
)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:DNAsm"></span>
<img src="chondro_files/figure-html/DNAsm-1.png" alt="False colour map of the DNA band intensities: smoothed DNA abundance. "><p class="caption">
Figure 7.1: False colour map of the DNA band intensities: smoothed DNA abundance.
</p>
</div>
<p>For interpolation (i.e., no smoothing at the available data points), a Voronoi plot (a.k.a. Delaunay triangulation) is basically a 2d constant interpolation: each point in space has the same z/color value as its closest available point.
For a full rectangular grid, this corresponds to the usual square/rectangular pixel plot.
With missing points, differences become clear (fig. <a href="#fig:DNAmissing">7.2</a>):</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="kw">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="kw">chondro</span>[, , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">728</span>, <span class="fl">782</span>, <span class="fl">1098</span>, <span class="fl">1240</span>, <span class="fl">1482</span>, <span class="fl">1577</span>)], <span class="fl">500</span>)
</pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit">
<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">tmp</span>, col.regions = <span class="kw">DNAcols</span>)
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:DNAmissing"></span>
<img src="chondro_files/figure-html/DNAmissing-1.png" alt='Two-dimesional (2D) "constant" interpolation with missing values: omitting missing data points. '><p class="caption">
Figure 7.2: Two-dimesional (2D) “constant” interpolation with missing values: omitting missing data points.
</p>
</div>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="fu"><a href="../reference/plotmap.html">plotmap</a></span>(<span class="kw">tmp</span>,
  col.regions = <span class="kw">DNAcols</span>,
  panel = <span class="kw">panel.voronoi</span>, pch = <span class="fl">19</span>, col = <span class="st">"black"</span>, cex = <span class="fl">0.1</span>
)
<span class="co">#&gt; </span>
<span class="co">#&gt;      PLEASE NOTE:  The components "delsgs" and "summary" of the</span>
<span class="co">#&gt;  object returned by deldir() are now DATA FRAMES rather than</span>
<span class="co">#&gt;  matrices (as they were prior to release 0.0-18).</span>
<span class="co">#&gt;  See help("deldir").</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt;      PLEASE NOTE: The process that deldir() uses for determining</span>
<span class="co">#&gt;  duplicated points has changed from that used in version</span>
<span class="co">#&gt;  0.0-9 of this package (and previously). See help("deldir").</span>
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:DNAvoronoi"></span>
<img src="chondro_files/figure-html/DNAvoronoi-1.png" alt='Two-dimesional (2D) "constant" interpolation with missing values: Delaunay triangulation / Voronoi plot.  '><p class="caption">
Figure 7.3: Two-dimesional (2D) “constant” interpolation with missing values: Delaunay triangulation / Voronoi plot.
</p>
</div>
<p>The 2D linear interpolation can be done, e.g., by the functions provided by package package <strong>akima</strong>.
However, they do not follow the model-predict paradigm, but instead do directly return an object suitable for base plotting with <code class="sourceCode r"><span class="kw">image</span>()</code> (fig. <a href="#fig:DNAinterp">7.4</a>):</p>
<div class="sourceCode" id="cb35"><pre class="downlit">
<span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="st">"akima"</span>)) {
  <span class="kw">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="kw">chondro</span>[[, , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">728</span>, <span class="fl">782</span>, <span class="fl">1098</span>, <span class="fl">1240</span>, <span class="fl">1482</span>, <span class="fl">1577</span>)]])
  <span class="kw">chondro.bilinear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/akima/man/interp.html">interp</a></span>(<span class="kw">chondro</span><span class="op">$</span><span class="kw">x</span>, <span class="kw">chondro</span><span class="op">$</span><span class="kw">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">tmp</span>), nx = <span class="fl">100</span>, ny = <span class="fl">100</span>)

  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span>(<span class="kw">chondro.bilinear</span>,
    xlab = <span class="fu"><a href="https://rdrr.io/r/base/labels.html">labels</a></span>(<span class="kw">chondro</span>, <span class="st">"x"</span>), ylab = <span class="fu"><a href="https://rdrr.io/r/base/labels.html">labels</a></span>(<span class="kw">chondro</span>, <span class="st">"y"</span>),
    col = <span class="kw">DNAcols</span>
  )
} <span class="co">else</span> {
  <span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="kw">NULL</span>, xlim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1</span>), ylim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1</span>))
  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">'Package "akima" is required to create this plot'</span>)
}
</pre></div>
<div class="figure" style="text-align: center">
<span id="fig:DNAinterp"></span>
<img src="chondro_files/figure-html/DNAinterp-1.png" alt="Two-dimensional (2D) interpolation.  "><p class="caption">
Figure 7.4: Two-dimensional (2D) interpolation.
</p>
</div>
</div>
<div id="sec:saving-data-set" class="section level1">
<h1 class="hasAnchor">
<a href="#sec:saving-data-set" class="anchor"></a><span class="header-section-number">8</span> Saving the data set</h1>
<p>Finally, the example data set is put together and saved.
In order to keep the package size small, only a PCA-compressed version with 10 PCs is shipped as example data set of the package.</p>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="kw">spectra_to_save</span><span class="op">$</span><span class="kw">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fl">NA</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="kw">chondro</span><span class="op">$</span><span class="kw">clusters</span>))
<span class="kw">spectra_to_save</span><span class="op">$</span><span class="kw">clusters</span>[<span class="op">-</span><span class="kw">out</span>] <span class="op">&lt;-</span> <span class="kw">chondro</span><span class="op">$</span><span class="kw">clusters</span>

<span class="kw">pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span>(<span class="kw">spectra_to_save</span>)

<span class="kw">.chondro_scores</span> <span class="op">&lt;-</span> <span class="kw">pca</span><span class="op">$</span><span class="kw">x</span>[, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fl">10</span>)]
<span class="kw">.chondro_loadings</span> <span class="op">&lt;-</span> <span class="kw">pca</span><span class="op">$</span><span class="kw">rot</span>[, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fl">10</span>)]
<span class="kw">.chondro_center</span> <span class="op">&lt;-</span> <span class="kw">pca</span><span class="op">$</span><span class="kw">center</span>
<span class="kw">.chondro_wl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wl.html">wl</a></span>(<span class="kw">chondro</span>)
<span class="kw">.chondro_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/labels.html">labels</a></span>(<span class="kw">chondro</span>), <span class="kw">as.expression</span>)
<span class="kw">.chondro_extra</span> <span class="op">&lt;-</span> <span class="kw">spectra_to_save</span><span class="op">$</span><span class="kw">..</span>

<span class="kw">chondro</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initialize.html">new</a></span>(<span class="st">"hyperSpec"</span>,
  spc = <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">tcrossprod</a></span>(<span class="kw">.chondro_scores</span>, <span class="kw">.chondro_loadings</span>) <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">.chondro_center</span>, each = <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">.chondro_scores</span>)),
  wavelength = <span class="kw">.chondro_wl</span>,
  data = <span class="kw">.chondro_extra</span>,
  labels = <span class="kw">.chondro_labels</span>
)
</pre></div>
<p>This is the file distributed with package <strong>hyperSpec</strong> as example data set.</p>
</div>
<div id="session-info" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session Info</h1>
<div class="sourceCode" id="cb37"><pre class="downlit">
<span class="kw">sessioninfo</span>::<span class="fu"><a href="https://rdrr.io/pkg/sessioninfo/man/session_info.html">session_info</a></span>(<span class="st">"hyperSpec"</span>)
<span class="co">#&gt; ─ Session info ───────────────────────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt;  setting  value                       </span>
<span class="co">#&gt;  version  R version 4.0.2 (2020-06-22)</span>
<span class="co">#&gt;  os       macOS Catalina 10.15.5      </span>
<span class="co">#&gt;  system   x86_64, darwin17.0          </span>
<span class="co">#&gt;  ui       X11                         </span>
<span class="co">#&gt;  language (EN)                        </span>
<span class="co">#&gt;  collate  en_US.UTF-8                 </span>
<span class="co">#&gt;  ctype    en_US.UTF-8                 </span>
<span class="co">#&gt;  tz       UTC                         </span>
<span class="co">#&gt;  date     2020-07-18                  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ─ Packages ───────────────────────────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt;  package      * version       date       lib source        </span>
<span class="co">#&gt;  assertthat     0.2.1         2019-03-21 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  backports      1.1.8         2020-06-17 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  callr          3.4.3         2020-03-28 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  cli            2.0.2         2020-02-28 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  colorspace     1.4-1         2019-03-18 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  crayon         1.3.4         2017-09-16 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  desc           1.2.0         2018-05-01 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  digest         0.6.25        2020-02-23 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  dplyr          1.0.0         2020-05-29 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  ellipsis       0.3.1         2020-05-15 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  evaluate       0.14          2019-05-28 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  fansi          0.4.1         2020-01-08 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  farver         2.0.3         2020-01-16 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  generics       0.0.2         2018-11-29 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  ggplot2      * 3.3.2         2020-06-19 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  glue           1.4.1         2020-05-13 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  gtable         0.3.0         2019-03-25 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  hyperSpec    * 0.99-20200615 2020-07-18 [1] local         </span>
<span class="co">#&gt;  isoband        0.2.2         2020-06-20 [1] CRAN (R 4.0.1)</span>
<span class="co">#&gt;  jpeg           0.1-8.1       2019-10-24 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  labeling       0.3           2014-08-23 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  lattice      * 0.20-41       2020-04-02 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  latticeExtra * 0.6-29        2019-12-19 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  lazyeval       0.2.2         2019-03-15 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  lifecycle      0.2.0         2020-03-06 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  magrittr       1.5           2014-11-22 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  MASS           7.3-51.6      2020-04-26 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  Matrix         1.2-18        2019-11-27 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  mgcv           1.8-31        2019-11-09 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  munsell        0.5.0         2018-06-12 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  nlme           3.1-148       2020-05-24 [2] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  pillar         1.4.6         2020-07-10 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  pkgbuild       1.1.0         2020-07-13 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  pkgconfig      2.0.3         2019-09-22 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  pkgload        1.1.0         2020-05-29 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  png            0.1-7         2013-12-03 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  praise         1.0.0         2015-08-11 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  prettyunits    1.1.1         2020-01-24 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  processx       3.4.3         2020-07-05 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  ps             1.3.3         2020-05-08 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  purrr          0.3.4         2020-04-17 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  R6             2.4.1         2019-11-12 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  RColorBrewer   1.1-2         2014-12-07 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  rlang          0.4.7         2020-07-09 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  rprojroot      1.3-2         2018-01-03 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  rstudioapi     0.11          2020-02-07 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  scales         1.1.1         2020-05-11 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  testthat       2.3.2         2020-03-02 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  tibble         3.0.3         2020-07-10 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  tidyselect     1.1.0         2020-05-11 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  utf8           1.1.4         2018-05-24 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  vctrs          0.3.2         2020-07-15 [1] CRAN (R 4.0.2)</span>
<span class="co">#&gt;  viridisLite    0.3.0         2018-02-01 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  withr          2.2.0         2020-04-20 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt;  xml2         * 1.3.2         2020-04-23 [1] CRAN (R 4.0.0)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [1] /Users/runner/work/_temp/Library</span>
<span class="co">#&gt; [2] /Library/Frameworks/R.framework/Versions/4.0/Resources/library</span>
</pre></div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Claudia Beleites, Valter Sergo.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
